<!DOCTYPE html>
<html lang="ca">
<head>
  <meta charset="UTF-8">
  <title>XifraRecerca</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
  <style>
    :root {
      --main-bg: #f9f9fa;
      --main-text: #224488;
      --container-bg: #fff;
      --container-shadow: 0 2px 16px #e1e1ef;
      --result-bg: #eef3ff;
      --alert-bg: #fde5e5;
      --alert-text: #a00;
      --button-bg: #224488;
      --button-hover: #1a3566;
      --download-bg: #338822;
      --download-hover: #266a16;
      --border: #aaa;
      --input-bg: #fff;
      --input-text: #222;
    }
    [data-theme="dark"] {
      --main-bg: #17181c;
      --main-text: #a3cdfd;
      --container-bg: #25262a;
      --container-shadow: 0 2px 16px #22253a;
      --result-bg: #232742;
      --alert-bg: #3b1b1b;
      --alert-text: #ff9494;
      --button-bg: #375a8c;
      --button-hover: #1a3566;
      --download-bg: #338822;
      --download-hover: #266a16;
      --border: #444;
      --input-bg: #25262a;
      --input-text: #fff;
    }
    body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--main-bg); margin: 0; padding: 0; color: var(--main-text);}
    .container { max-width: 500px; margin: 40px auto; background: var(--container-bg); border-radius: 12px; box-shadow: var(--container-shadow); padding: 32px; }
    h1 { text-align: center; color: var(--main-text); }
    h2 { color: var(--main-text); margin-top: 0; }
    button, input, textarea { font-size: 1rem; margin-top: 10px; }
    button { background: var(--button-bg); color: #fff; border: none; border-radius: 8px; padding: 12px 32px; cursor: pointer; transition: background .2s; }
    button:hover { background: var(--button-hover); }
    .row { display: flex; gap: 12px; margin-bottom: 18px; }
    .row > * { flex: 1; }
    label { font-weight: 500; }
    textarea, input[type="number"], input[type="text"] { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 6px; resize: vertical; min-height: 40px; background: var(--input-bg); color: var(--input-text);}
    .result { background: var(--result-bg); border-radius: 8px; padding: 16px; margin-top: 18px; white-space: pre-wrap; font-size: 1.05em; color: inherit;}
    .back { margin-top: 24px; display: block; text-align: center; color: var(--main-text); cursor: pointer; text-decoration: underline; }
    .download-btn { background: var(--download-bg); }
    .download-btn:hover { background: var(--download-hover); }
    .small { font-size: 0.9em; color: #555; }
    .alert { background: var(--alert-bg); color: var(--alert-text); padding: 8px; border-radius: 6px; margin-bottom: 10px; font-size: .98em;}
    .footer { text-align: center; font-size: .93em; color: #aaa; margin: 36px 0 0; }
    #spinner { display:none; text-align:center; margin:16px 0; }
    .aria-hidden { display:none; }
    .mode-toggle { float:right; margin-top:-8px; }
    .mode-toggle button { padding: 6px 18px; font-size: 0.95em; background: #dbe9fa; color: #224488; border-radius:20px; border:none;}
    .mode-toggle button.active { background: #224488; color: #fff; }
    .lang-selector { float:left; margin-top:-8px;}
    .lang-selector select { padding:4px 10px; border-radius:8px; font-size:0.95em; }
    .advanced-toggle { cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 1em; margin-top: 12px; }
    .advanced-content { display: none; margin-top: 8px; }
    .opcions-advanced { border:1px dashed var(--border); border-radius:6px; padding:12px; background:var(--result-bg);}
    .opcions-advanced label { font-weight:400; }
    [data-theme="dark"] .opcions-advanced { background: #232742; color: #fff;}
    [data-theme="dark"] .small { color: #ccc;}
    [data-theme="dark"] label { color: #fff;}
    [data-theme="dark"] .alert { color: #ff9494;}
    .warning-primes { background: #fde5e5; color: #a00; border-radius: 8px; padding: 12px; margin-top: 18px; font-size: 1em;}
    [data-theme="dark"] .warning-primes { background: #3b1b1b; color: #ff9494; }
  </style>
</head>
<body data-theme="light">
  <div class="container" role="main" aria-label="Aplicaci√≥ RSA">
    <div class="mode-toggle" aria-label="Canvi de tema">
      <button id="toggle-dark">üåô</button>
      <button id="toggle-light" class="active">‚òÄÔ∏è</button>
    </div>
    <div class="lang-selector" aria-label="Selector d'idioma">
      <select id="lang-select" aria-label="Canvia l'idioma">
        <option value="ca">Catal√†</option>
        <option value="es">Castellano</option>
        <option value="en">English</option>
        <option value="fr">Fran√ßais</option>
      </select>
    </div>
    <div id="pantalla-inici">
      <h1>XifraRecerca</h1>
      <p id="welcome-msg">
        Benvingut a XifraRecerca, el teu xifrador i desxifrador de confian√ßa,<br>
       desenvolupat per Marc San Jos√© Casals com a part del treball de recerca de batxillerat. <br>
	   Per qualsevol dubte o sugger√®ncia, no dubtis a contactar-me a msanjosecasals@inspineda.com
      </p>
      <div style="margin-top:30px; display:flex; flex-direction:column; gap:16px;">
        <button onclick="mostrarPantalla('xifrar')" aria-label="Xifrar un missatge" id="btn-xifrar">Xifrar un missatge</button>
        <button onclick="mostrarPantalla('desxifrar')" aria-label="Desxifrar un missatge" id="btn-desxifrar">Desxifrar un missatge</button>
      </div>
    </div>

    <div id="pantalla-xifrar" style="display:none;" aria-label="Pantalla xifrar">
      <h2 id="title-xifrar">üîê Xifrar un missatge</h2>
      <form id="form-xifrar" autocomplete="off" aria-label="Formulari xifrar" role="form">
        <label for="input-text" id="label-text">Text original:</label>
        <textarea id="input-text" rows="3" required aria-required="true"></textarea>
        <div class="row">
          <div>
            <label for="input-p" id="label-p">Nombre primer p (‚â•2):</label>
            <input type="number" id="input-p" min="2" max="10000019" step="1" required aria-required="true" aria-label="Primer p" aria-describedby="p-help">
            <span id="p-help" class="small"></span>
          </div>
          <div>
            <label for="input-q" id="label-q">Nombre primer q (‚â•2):</label>
            <input type="number" id="input-q" min="2" max="10000019" step="1" required aria-required="true" aria-label="Primer q" aria-describedby="q-help">
            <span id="q-help" class="small"></span>
          </div>
        </div>
        <div class="advanced-toggle" id="toggle-advanced"><span>‚öôÔ∏è</span><span id="advanced-title">Opcions avan√ßades</span><span id="advanced-arrow">‚ñº</span></div>
        <div class="advanced-content" id="advanced-content">
          <div class="opcions-advanced">
            <label for="input-e" id="label-e">Valor de la clau p√∫blica e:</label>
            <input type="number" id="input-e" value="65537" min="3" step="2"><br>
            <label>
              <input type="checkbox" id="toggle-bits">
              <span id="text-toggle-bits">Mostra la mida de la clau</span>
            </label><br>
            <label>
              <input type="checkbox" id="toggle-bytes">
              <span id="text-toggle-bytes">Mostra el pes en bytes del missatge xifrat</span>
            </label>
          </div>
        </div>
        <div id="claus-bits" class="small" aria-live="polite" style="display:none;"></div>
        <div id="claus-bytes" class="small" aria-live="polite" style="display:none;"></div>
        <div id="claus-ms" class="small" aria-live="polite" style="display:none;"></div>
        <button type="submit" aria-label="Xifrar" id="btn-submit-xifrar">Xifrar</button>
      </form>
      <div id="alert-xifrar" class="alert" style="display:none;" role="alert"></div>
      <div id="spinner"><img src="https://cdn.jsdelivr.net/gh/marcsse/xifrarecerca/spinner.svg" alt="Carregant..." width="32"><br><span id="load-msg"></span></div>
      <div id="result-xifrar" class="result" style="display:none;" aria-live="polite"></div>
      <button id="copy-result" style="display:none;">Copia al porta-retalls</button>
      <button id="download-xifrar" class="download-btn" style="display:none;">Descarrega resultat (.txt)</button>
      <div class="warning-primes" id="small-primes-warning" style="display:none;"></div>
      <div class="back" onclick="mostrarPantalla('inici')" tabindex="0" id="back-xifrar">‚Üê Torna a l'inici</div>
    </div>

    <div id="pantalla-desxifrar" style="display:none;" aria-label="Pantalla desxifrar">
      <h2 id="title-desxifrar">üîì Desxifrar un missatge</h2>
      <form id="form-desxifrar" autocomplete="off" aria-label="Formulari desxifrar" role="form">
        <label for="input-xifrat" id="label-xifrat">Missatge xifrat (llista de nombres separats per comes):</label>
        <textarea id="input-xifrat" rows="3" required aria-required="true"></textarea>
        <div class="row">
          <div>
            <label for="input-d" id="label-d">Clau privada d:</label>
            <input type="number" id="input-d" min="1" step="1" required aria-required="true">
          </div>
          <div>
            <label for="input-n" id="label-n">Clau privada n:</label>
            <input type="number" id="input-n" min="2" step="1" required aria-required="true">
          </div>
        </div>
        <button type="submit" aria-label="Desxifrar" id="btn-submit-desxifrar">Desxifrar</button>
      </form>
      <div id="result-desxifrar" class="result" style="display:none;" aria-live="polite"></div>
      <button id="copy-desxifrat" style="display:none;">Copia al porta-retalls</button>
      <div class="small" id="claus-ms-desxifrar" style="display:none;"></div>
      <div class="back" onclick="mostrarPantalla('inici')" tabindex="0" id="back-desxifrar">‚Üê Torna a l'inici</div>
    </div>
  </div>
  <div class="footer" aria-label="Peu de p√†gina">
    &copy; 2025 XifraRecerca ¬∑ Fet per Marc San Jos√©
  </div>

  <script>
    // ========== Internacionalitzaci√≥ ==========
    const texts = {
      ca: {
        welcome: 'Benvingut a XifraRecerca, el teu xifrador i desxifrador de confian√ßa,<br>desenvolupat per Marc San Jos√© Casals com a part del treball de recerca de batxillerat.<br>Per qualsevol dubte o sugger√®ncia, no dubtis a contactar-me a msanjosecasals@inspineda.com',
        xifrar: 'Xifrar un missatge',
        desxifrar: 'Desxifrar un missatge',
        copy: 'Copia al porta-retalls',
        copied: 'Copiat al porta-retalls!',
        downloading: 'Descarrega resultat (.txt)',
        bits: n => `Mida de n: <b>${n.toString(2).length}</b> bits`,
        bytes: b => `Pes en bytes del missatge xifrat: <b>${b}</b> bytes`,
        ms: ms => `Temps de xifrat/desxifrat: <b>${ms}</b> ms`,
        loading: 'Carregant Python...',
        invalidPrime: 'Almenys un dels nombres NO √©s primer.',
        samePrime: 'p i q han de ser <b>nombres primers diferents</b>!',
        tooBig: 'Els nombres s√≥n massa grans (m√†xim: 10.000.019).',
        notPrime: name => `El nombre <b>${name}</b> no √©s primer.`,
        notSupportedChar: 'El text cont√© car√†cters no suportats (emojis o s√≠mbols especials).',
        selectLang: 'Canvia l\'idioma',
        advanced: 'Opcions avan√ßades',
        labelE: 'Valor de la clau p√∫blica e:',
        toggleBits: 'Mostra la mida de la clau',
        toggleBytes: 'Mostra el pes en bytes del missatge xifrat',
        smallPrimesWarning: '‚ö†Ô∏è ATENCI√ì: Bones, mag de la criptografia! Has triat nombres massa petits per xifrar de forma segura... (Ideal per a demostracions, per√≤ ni s‚Äôaconsella enviar secrets de veritat aix√≠!) Si no vols que t‚Äôenxampin, et recomano que utilitzis nombres primers d‚Äôalmenys sis xifres, com per exemple p = 104729 i q =1000039.',
      },
      es: {
        welcome: 'Bienvenido a XifraRecerca, tu cifrador y descifrador de confianza,<br>desarrollado por Marc San Jos√© Casals como parte del trabajo de investigaci√≥n de bachillerato.<br>Para cualquier duda o sugerencia, cont√°ctame en msanjosecasals@inspineda.com',
        xifrar: 'Cifrar un mensaje',
        desxifrar: 'Descifrar un mensaje',
        copy: 'Copiar al portapapeles',
        copied: '¬°Copiado al portapapeles!',
        downloading: 'Descarga resultado (.txt)',
        bits: n => `Tama√±o de n: <b>${n.toString(2).length}</b> bits`,
        bytes: b => `Peso en bytes del mensaje cifrado: <b>${b}</b> bytes`,
        ms: ms => `Tiempo de cifrado/descifrado: <b>${ms}</b> ms`,
        loading: 'Cargando Python...',
        invalidPrime: '¬°Alguno de los n√∫meros NO es primo!',
        samePrime: '¬°p y q deben ser <b>primos distintos</b>!',
        tooBig: 'Los n√∫meros son demasiado grandes (m√°ximo: 10.000.019).',
        notPrime: name => `El n√∫mero <b>${name}</b> no es primo.`,
        notSupportedChar: 'El texto contiene caracteres no soportados (emojis o s√≠mbolos especiales).',
        selectLang: 'Cambia idioma',
        advanced: 'Opciones avanzadas',
        labelE: 'Valor de la clave p√∫blica e:',
        toggleBits: 'Mostrar tama√±o de la clave',
        toggleBytes: 'Mostrar peso en bytes del mensaje cifrado',
        smallPrimesWarning: '‚ö†Ô∏è ¬°Atenci√≥n, mago de la criptograf√≠a! Has elegido n√∫meros demasiado peque√±os para cifrar... (Ideal para demostraciones, pero no se recomienda enviar secretos reales as√≠). Si no quieres que te pillen, te recomiendo usar n√∫meros primos de al menos seis cifras, como p = 104729 y q = 1000039.',
      },
      en: {
        welcome: 'Welcome to XifraRecerca, your trusted encryptor and decryptor,<br>developed by Marc San Jos√© Casals as part of his high school research project.<br>For any questions or suggestions, contact me at msanjosecasals@inspineda.com',
        xifrar: 'Encrypt a message',
        desxifrar: 'Decrypt a message',
        copy: 'Copy to clipboard',
        copied: 'Copied to clipboard!',
        downloading: 'Download result (.txt)',
        bits: n => `Key size n: <b>${n.toString(2).length}</b> bits`,
        bytes: b => `Encrypted message size: <b>${b}</b> bytes`,
        ms: ms => `Encryption/decryption time: <b>${ms}</b> ms`,
        loading: 'Loading Python...',
        invalidPrime: 'At least one number is NOT prime.',
        samePrime: 'p and q must be <b>different prime numbers</b>!',
        tooBig: 'Numbers are too large (max: 10,000,019).',
        notPrime: name => `The number <b>${name}</b> is not prime.`,
        notSupportedChar: 'Text contains unsupported characters (emojis or special symbols).',
        selectLang: 'Change language',
        advanced: 'Advanced options',
        labelE: 'Value of public key e:',
        toggleBits: 'Show key size',
        toggleBytes: 'Show encrypted message size in bytes',
        smallPrimesWarning: '‚ö†Ô∏è ATTENTION: Crypto wizard! You\'ve chosen numbers that are too small for encryption... (Good for demos, but not recommended for real secrets!) If you don\'t want to get caught, use primes with at least six digits, like p = 104729 and q = 1000039.',
      },
      fr: {
        welcome: 'Bienvenue sur XifraRecerca, ton outil de chiffrement/d√©chiffrement de confiance,<br>d√©velopp√© par Marc San Jos√© Casals dans le cadre d\'un travail de recherche au lyc√©e.<br>Pour toute question ou suggestion, contacte-moi √† msanjosecasals@inspineda.com',
        xifrar: 'Chiffrer un message',
        desxifrar: 'D√©chiffrer un message',
        copy: 'Copier dans le presse-papiers',
        copied: 'Copi√© dans le presse-papiers !',
        downloading: 'T√©l√©charger le r√©sultat (.txt)',
        bits: n => `Taille de n¬†: <b>${n.toString(2).length}</b> bits`,
        bytes: b => `Poids en octets du message chiffr√©¬†: <b>${b}</b> octets`,
        ms: ms => `Temps de chiffrement/d√©chiffrement¬†: <b>${ms}</b> ms`,
        loading: 'Chargement de Python...',
        invalidPrime: 'Au moins un des nombres N\'EST PAS premier.',
        samePrime: 'p et q doivent √™tre <b>des nombres premiers diff√©rents</b> !',
        tooBig: 'Les nombres sont trop grands (max : 10 000 019).',
        notPrime: name => `Le nombre <b>${name}</b> n\'est pas premier.`,
        notSupportedChar: 'Le texte contient des caract√®res non pris en charge (emojis ou symboles sp√©ciaux).',
        selectLang: 'Changer de langue',
        advanced: 'Options avanc√©es',
        labelE: 'Valeur de la cl√© publique e¬†:',
        toggleBits: 'Afficher la taille de la cl√©',
        toggleBytes: 'Afficher le poids en octets du message chiffr√©',
        smallPrimesWarning: '‚ö†Ô∏è ATTENTION¬†: Magicien de la crypto¬†! Tu as choisi des nombres trop petits pour le chiffrement... (Bien pour les d√©mos, mais pas pour des secrets r√©els¬†!) Pour ne pas te faire pi√©ger, utilise des premiers d\'au moins six chiffres, comme p = 104729 et q = 1000039.',
      }
    };
    let currentLang = 'ca';
    function setLang(l) {
      currentLang = l;
      document.getElementById('welcome-msg').innerHTML = texts[l].welcome;
      document.getElementById('toggle-dark').title = l === 'en' ? 'Dark mode' : (l === 'es' ? 'Modo oscuro' : (l === 'fr' ? 'Mode sombre' : 'Mode fosc'));
      document.getElementById('toggle-light').title = l === 'en' ? 'Light mode' : (l === 'es' ? 'Modo claro' : (l==='fr'?'Mode clair':'Mode clar'));
      document.getElementById('btn-xifrar').textContent = texts[l].xifrar;
      document.getElementById('btn-desxifrar').textContent = texts[l].desxifrar;
      document.getElementById('title-xifrar').textContent = `üîê ${texts[l].xifrar}`;
      document.getElementById('label-text').textContent = texts[l].xifrar + ':';
      document.getElementById('label-p').textContent = l === 'fr' ? 'Nombre premier p (‚â•2):' : (l === 'en' ? 'Prime number p (‚â•2):' : (l === 'es' ? 'N√∫mero primo p (‚â•2):' : 'Nombre primer p (‚â•2):'));
      document.getElementById('label-q').textContent = l === 'fr' ? 'Nombre premier q (‚â•2):' : (l === 'en' ? 'Prime number q (‚â•2):' : (l === 'es' ? 'N√∫mero primo q (‚â•2):' : 'Nombre primer q (‚â•2):'));
      document.getElementById('advanced-title').textContent = texts[l].advanced;
      document.getElementById('label-e').textContent = texts[l].labelE;
      document.getElementById('text-toggle-bits').textContent = texts[l].toggleBits;
      document.getElementById('text-toggle-bytes').textContent = texts[l].toggleBytes;
      document.getElementById('btn-submit-xifrar').textContent = texts[l].xifrar;
      document.getElementById('title-desxifrar').textContent = `üîì ${texts[l].desxifrar}`;
      document.getElementById('label-xifrat').textContent = l === 'fr' ? 'Message chiffr√© (liste de nombres s√©par√©s par des virgules):' : (l === 'en' ? 'Encrypted message (comma separated numbers):' : (l === 'es' ? 'Mensaje cifrado (lista de n√∫meros separados por comas):' : 'Missatge xifrat (llista de nombres separats per comes):'));
      document.getElementById('label-d').textContent = l === 'fr' ? 'Cl√© priv√©e d:' : (l === 'en' ? 'Private key d:' : (l === 'es' ? 'Clave privada d:' : 'Clau privada d:'));
      document.getElementById('label-n').textContent = l === 'fr' ? 'Cl√© priv√©e n:' : (l === 'en' ? 'Private key n:' : (l === 'es' ? 'Clave privada n:' : 'Clau privada n:'));
      document.getElementById('btn-submit-desxifrar').textContent = texts[l].desxifrar;
      document.getElementById('copy-result').textContent = texts[l].copy;
      document.getElementById('download-xifrar').textContent = texts[l].downloading;
      document.getElementById('copy-desxifrat').textContent = texts[l].copy;
      document.getElementById('lang-select').title = texts[l].selectLang;
      document.getElementById('back-xifrar').innerHTML = l==='en'?'‚Üê Back to start':(l==='es'?'‚Üê Volver al inicio':(l==='fr'?'‚Üê Retour √† l\'accueil':'‚Üê Torna a l\'inici'));
      document.getElementById('back-desxifrar').innerHTML = l==='en'?'‚Üê Back to start':(l==='es'?'‚Üê Volver al inicio':(l==='fr'?'‚Üê Retour √† l\'accueil':'‚Üê Torna a l\'inici'));
      validatePrimes();
    }
    document.getElementById('lang-select').addEventListener('change', e=>setLang(e.target.value));
    setLang('ca');

    // ========== Mode fosc ========== 
    function setTheme(t) {
      document.body.setAttribute('data-theme', t);
      document.getElementById('toggle-dark').classList.toggle('active', t==='dark');
      document.getElementById('toggle-light').classList.toggle('active', t==='light');
    }
    document.getElementById('toggle-dark').onclick = ()=>setTheme('dark');
    document.getElementById('toggle-light').onclick = ()=>setTheme('light');

    // ========== Advanced menu toggle ==========
    document.getElementById('toggle-advanced').onclick = function() {
      let content = document.getElementById('advanced-content');
      let arrow = document.getElementById('advanced-arrow');
      if (content.style.display === 'block') {
        content.style.display = 'none';
        arrow.textContent = '‚ñº';
      } else {
        content.style.display = 'block';
        arrow.textContent = '‚ñ≤';
      }
    };

    // ========== Navegaci√≥ ==========
    function mostrarPantalla(quin) {
      document.getElementById('pantalla-inici').style.display = quin === 'inici' ? '' : 'none';
      document.getElementById('pantalla-xifrar').style.display = quin === 'xifrar' ? '' : 'none';
      document.getElementById('pantalla-desxifrar').style.display = quin === 'desxifrar' ? '' : 'none';
      document.getElementById('result-xifrar').style.display = 'none';
      document.getElementById('download-xifrar').style.display = 'none';
      document.getElementById('copy-result').style.display = 'none';
      document.getElementById('result-desxifrar').style.display = 'none';
      document.getElementById('copy-desxifrat').style.display = 'none';
      document.getElementById('alert-xifrar').style.display = 'none';
      document.getElementById('claus-bits').style.display = 'none';
      document.getElementById('claus-bytes').style.display = 'none';
      document.getElementById('claus-ms').style.display = 'none';
      document.getElementById('claus-ms-desxifrar').style.display = 'none';
      document.getElementById('small-primes-warning').style.display = 'none';
      if (quin === 'xifrar') document.getElementById('form-xifrar').reset();
      if (quin === 'desxifrar') document.getElementById('form-desxifrar').reset();
      // Reset advanced options to default
      document.getElementById('input-e').value = '65537';
      document.getElementById('toggle-bits').checked = false;
      document.getElementById('toggle-bytes').checked = false;
      document.getElementById('advanced-content').style.display = 'none';
      document.getElementById('advanced-arrow').textContent = '‚ñº';
    }

    // ========== Validaci√≥ d'entrada ========== 
    function esPrimer(n) {
      if (n<2) return false;
      if (n===2) return true;
      if (n%2===0) return false;
      let sqrt = Math.floor(Math.sqrt(n));
      for(let i=3;i<=sqrt;i+=2) if (n%i===0) return false;
      return true;
    }
    function validatePrimes() {
      let p = parseInt(document.getElementById('input-p').value,10);
      let q = parseInt(document.getElementById('input-q').value,10);
      let alertMsg = '';
      let pHelp = '';
      let qHelp = '';
      if (p && !esPrimer(p)) pHelp = texts[currentLang].notPrime('p');
      if (q && !esPrimer(q)) qHelp = texts[currentLang].notPrime('q');
      if (p && q && p===q) alertMsg = texts[currentLang].samePrime;
      if ((p && p>10000019)||(q && q>10000019)) alertMsg = texts[currentLang].tooBig;
      document.getElementById('p-help').innerHTML = pHelp;
      document.getElementById('q-help').innerHTML = qHelp;
      document.getElementById('alert-xifrar').innerHTML = alertMsg;
      document.getElementById('alert-xifrar').style.display = (alertMsg||pHelp||qHelp)?'':'none';
      let showBits = document.getElementById('toggle-bits').checked;
      if (p && q && esPrimer(p) && esPrimer(q) && p!==q && p<=10000019 && q<=10000019 && showBits) {
        let n = p*q;
        document.getElementById('claus-bits').innerHTML = texts[currentLang].bits(n);
        document.getElementById('claus-bits').style.display = '';
      } else {
        document.getElementById('claus-bits').innerHTML = '';
        document.getElementById('claus-bits').style.display = 'none';
      }
    }
    document.getElementById('input-p').addEventListener('blur', validatePrimes);
    document.getElementById('input-q').addEventListener('blur', validatePrimes);
    document.getElementById('input-p').addEventListener('input', validatePrimes);
    document.getElementById('input-q').addEventListener('input', validatePrimes);
    document.getElementById('toggle-bits').addEventListener('change', validatePrimes);

    // ========== Indicador de c√†rrega ==========
    let pyodideReady = false;
    let pyodide = null;
    const pythonCode = `
def mcd(a, b):
    while b:
        a, b = b, a % b
    return a

def invers_mod(a, m):
    t, nova_t = 0, 1
    r, nova_r = m, a
    while nova_r != 0:
        q = r // nova_r
        t, nova_t = nova_t, t - q * nova_t
        r, nova_r = nova_r, r - q * nova_r
    if r > 1:
        return None
    if t < 0:
        t += m
    return t

def es_primer(n):
    if n < 2:
        return False
    if n == 2:
        return True
    if n % 2 == 0:
        return False
    for i in range(3, int(n ** 0.5) + 1, 2):
        if n % i == 0:
            return False
    return True

def generar_claus_segures(p, q, e=65537):
    if not es_primer(p) or not es_primer(q):
        raise Exception("Almenys un dels nombres NO √©s primer.")
    if p == q:
        raise Exception("p i q han de ser diferents.")
    n = p * q
    phi = (p - 1) * (q - 1)
    if mcd(e, phi) != 1:
        e = 3
        while mcd(e, phi) != 1:
            e += 2
    d = invers_mod(e, phi)
    if d is None:
        raise Exception("No s'ha pogut calcular la clau privada amb aquests nombres. Prova amb altres nombres primers.")
    return (e, n), (d, n)

def text_a_blocs(text, mida_bloc):
    blocs = []
    for i in range(0, len(text), mida_bloc):
        bloc = text[i:i + mida_bloc]
        num = 0
        for c in bloc:
            num = num * 256 + ord(c)
        blocs.append(num)
    return blocs

def xifrar_blocs(blocs, clau_pub):
    e, n = clau_pub
    return [pow(b, e, n) for b in blocs]

def xifrar_paragrafs(text, mida_bloc, clau_pub):
    paragrafs = text.split('\\n')
    xifrat_paragrafs = []
    for par in paragrafs:
        blocs = text_a_blocs(par, mida_bloc)
        xifrat = xifrar_blocs(blocs, clau_pub)
        xifrat_paragrafs.append(xifrat)
    return xifrat_paragrafs

def blocs_a_text(blocs, mida_bloc):
    text = ""
    for num in blocs:
        chars = []
        for _ in range(mida_bloc):
            chars.append(chr(num % 256))
            num //= 256
        chars.reverse()
        text += "".join(chars)
    return text

def desxifrar_blocs(blocs_xifrats, clau_priv):
    d, n = clau_priv
    return [pow(b, d, n) for b in blocs_xifrats]

def desxifrar_text(xifrat_blocs, clau_priv):
    d, n = clau_priv
    mida_bloc = 1
    while (256 ** (mida_bloc + 1)) < n:
        mida_bloc += 1
    blocs = desxifrar_blocs(xifrat_blocs, clau_priv)
    text = blocs_a_text(blocs, mida_bloc)
    text = text.lstrip('\\x00')
    return text
`;
    async function carregarPyodide() {
      document.getElementById('spinner').style.display = '';
      document.getElementById('load-msg').textContent = texts[currentLang].loading;
      pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.24.1/full/" });
      pyodide.runPython(pythonCode);
      pyodideReady = true;
      document.getElementById('spinner').style.display = 'none';
    }
    carregarPyodide();

    // ========== Validaci√≥ de car√†cters ==========
    function textValid(text) {
      // Permet lletres, n√∫meros, espais, signes b√†sics
      // Prohibeix emojis (surrogates) o car√†cters rares
      return /^[\u0000-\u00FF\u0100-\u017F\u0180-\u024F\s\.,;:?!¬°¬ø'"()\-_\[\]{}\n\r]+$/.test(text);
    }

    // ========== Xifrar ==========
    document.getElementById('form-xifrar').onsubmit = async function(e) {
      e.preventDefault();
      document.getElementById('small-primes-warning').style.display = 'none';
      if (!pyodideReady) { alert(texts[currentLang].loading); return; }
      let text = document.getElementById('input-text').value;
      let p = parseInt(document.getElementById('input-p').value, 10);
      let q = parseInt(document.getElementById('input-q').value, 10);
      // Claus per defecte si no s'han posat
      if (isNaN(p)) p = 104729;
      if (isNaN(q)) q = 1000039;
      // Si p o q no s√≥n primers de 6 xifres, assigna autom√†ticament dos segurs:
      if (p < 1000) p = 104729;
      if (q < 1000) q = 1000039;
      if (!textValid(text)) {
        document.getElementById('alert-xifrar').innerHTML = texts[currentLang].notSupportedChar;
        document.getElementById('alert-xifrar').style.display = '';
        return;
      }
      if (!text.trim()) return alert('Introdueix un text!');
      if (!esPrimer(p) || !esPrimer(q)) {
        document.getElementById('alert-xifrar').innerHTML = texts[currentLang].invalidPrime;
        document.getElementById('alert-xifrar').style.display = '';
        return;
      }
      if (p === q) {
        document.getElementById('alert-xifrar').innerHTML = texts[currentLang].samePrime;
        document.getElementById('alert-xifrar').style.display = '';
        return;
      }
      if (p > 10000019 || q > 10000019) {
        document.getElementById('alert-xifrar').innerHTML = texts[currentLang].tooBig;
        document.getElementById('alert-xifrar').style.display = '';
        return;
      }
      document.getElementById('alert-xifrar').style.display = 'none';
      document.getElementById('spinner').style.display = '';
      document.getElementById('load-msg').textContent = texts[currentLang].loading;
      // Opcions avan√ßades
      let eValue = parseInt(document.getElementById('input-e').value, 10);
      if (isNaN(eValue) || eValue < 3) eValue = 65537;
      let showBits = document.getElementById('toggle-bits').checked;
      let showBytes = document.getElementById('toggle-bytes').checked;
      let start = performance.now();
      try {
        pyodide.runPython(`
p = ${p}
q = ${q}
e = ${eValue}
clau_pub, clau_priv = generar_claus_segures(p, q, e)
n = clau_pub[1]
mida_bloc = 1
while (256 ** (mida_bloc + 1)) < n:
    mida_bloc += 1
text_usuari = """${text.replace(/"/g, '\\"').replace(/\n/g, '\\n')}"""
xifrat = xifrar_paragrafs(text_usuari, mida_bloc, clau_pub)
xifrat_concatenat = []
for par in xifrat:
    xifrat_concatenat.extend(par)
        `);
        let clau_pub = pyodide.globals.get('clau_pub').toJs();
        let clau_priv = pyodide.globals.get('clau_priv').toJs();
        let mida_bloc = pyodide.globals.get('mida_bloc');
        let xifrat_concatenat = pyodide.globals.get('xifrat_concatenat').toJs();
        let n = clau_pub[1];
        let end = performance.now();
        let ms = Math.round(end - start);
        let res = `<b>Missatge xifrat:</b><br>
        <span class="small">Llista de nombres (separa per comes per desxifrar):</span><br>
        ${xifrat_concatenat.join(', ')}<br>
        <br><b>Clau p√∫blica (e, n):</b> (${clau_pub[0]}, ${clau_pub[1]})<br>
        <b>Clau privada (d, n):</b> (${clau_priv[0]}, ${clau_priv[1]})<br>
        <span class="small">Mida de bloc per xifrar: ${mida_bloc} car√†cters</span>`;
        document.getElementById('result-xifrar').innerHTML = res;
        document.getElementById('result-xifrar').style.display = '';
        document.getElementById('claus-bits').style.display = showBits ? '' : 'none';
        document.getElementById('claus-bytes').style.display = showBytes ? '' : 'none';
        document.getElementById('claus-ms').style.display = '';
        document.getElementById('claus-bits').innerHTML = showBits ? texts[currentLang].bits(n) : '';
        let bytes = new TextEncoder().encode(xifrat_concatenat.join(',')).length;
        document.getElementById('claus-bytes').innerHTML = showBytes ? texts[currentLang].bytes(bytes) : '';
        document.getElementById('claus-ms').innerHTML = texts[currentLang].ms(ms);
        let txt = `Missatge xifrat:\n${xifrat_concatenat.join(', ')}\n\nClau p√∫blica (e, n): (${clau_pub[0]}, ${clau_pub[1]})\nClau privada (d, n): (${clau_priv[0]}, ${clau_priv[1]})\nMida de bloc: ${mida_bloc} car√†cters\n`;
        document.getElementById('download-xifrar').onclick = function() {
          let blob = new Blob([txt], {type: 'text/plain'});
          let a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = 'xifrarecerca_resultat.txt';
          a.click();
        };
        document.getElementById('download-xifrar').style.display = '';
        document.getElementById('copy-result').style.display = '';
        document.getElementById('copy-result').onclick = () => {
          navigator.clipboard.writeText(xifrat_concatenat.join(', ')).then(() => {
            alert(texts[currentLang].copied);
          });
        };
        // Alerta si p o q < 1000
        if ((parseInt(document.getElementById('input-p').value,10)<1000)||(parseInt(document.getElementById('input-q').value,10)<1000)) {
          document.getElementById('small-primes-warning').innerHTML = texts[currentLang].smallPrimesWarning;
          document.getElementById('small-primes-warning').style.display = '';
        }
      } catch(err) {
        let msg = err.message || '';
        if (msg.indexOf('NO √©s primer') !== -1) {
          msg = texts[currentLang].invalidPrime;
        } else if (msg.indexOf('No s\'ha pogut calcular la clau privada') !== -1) {
          msg = "Error: No s'ha pogut calcular la clau privada amb aquests nombres. Prova amb altres nombres primers.";
        } else if (msg.indexOf('diferents') !== -1) {
          msg = texts[currentLang].samePrime;
        } else {
          msg = "Error inesperat. Comprova els nombres i el text.";
        }
        document.getElementById('result-xifrar').innerHTML = msg;
        document.getElementById('result-xifrar').style.display = '';
        document.getElementById('download-xifrar').style.display = 'none';
        document.getElementById('copy-result').style.display = 'none';
      }
      document.getElementById('spinner').style.display = 'none';
    };

    // ========== Desxifrar ==========
    document.getElementById('form-desxifrar').onsubmit = async function(e) {
      e.preventDefault();
      if (!pyodideReady) { alert(texts[currentLang].loading); return; }
      let xifrat_str = document.getElementById('input-xifrat').value.trim();
      let d = parseInt(document.getElementById('input-d').value, 10);
      let n = parseInt(document.getElementById('input-n').value, 10);
      if (!xifrat_str) return alert('Introdueix el missatge xifrat!');
      if (isNaN(d) || isNaN(n)) return alert('Introdueix la clau privada!');
      let blocs = xifrat_str.split(',').map(x => parseInt(x.trim(), 10)).filter(x => !isNaN(x));
      if (!blocs.length) return alert('El missatge xifrat no √©s v√†lid!');
      document.getElementById('spinner').style.display = '';
      document.getElementById('load-msg').textContent = texts[currentLang].loading;
      let start = performance.now();
      try {
        pyodide.runPython(`
clau_priv = (${d}, ${n})
xifrat_blocs = ${JSON.stringify(blocs)}
text_desxifrat = desxifrar_text(xifrat_blocs, clau_priv)
        `);
        let text_desxifrat = pyodide.globals.get('text_desxifrat');
        let end = performance.now();
        let ms = Math.round(end - start);
        let res = `<b>Text desxifrat:</b><br>${text_desxifrat || '[Buit o error de desxifrat]'}<br>
        <br><span class="small">Gr√†cies per utilitzar el XifraRecerca. Torna a l'inici per xifrar un altre missatge.</span>`;
        document.getElementById('result-desxifrar').innerHTML = res;
        document.getElementById('result-desxifrar').style.display = '';
        document.getElementById('copy-desxifrat').style.display = '';
        document.getElementById('copy-desxifrat').onclick = () => {
          navigator.clipboard.writeText(text_desxifrat).then(() => {
            alert(texts[currentLang].copied);
          });
        };
        document.getElementById('claus-ms-desxifrar').style.display = '';
        document.getElementById('claus-ms-desxifrar').innerHTML = texts[currentLang].ms(ms);
      } catch(err) {
        document.getElementById('result-desxifrar').innerHTML = 'Error en desxifrar! Revisa la clau privada i el missatge.';
        document.getElementById('result-desxifrar').style.display = '';
        document.getElementById('copy-desxifrat').style.display = 'none';
        document.getElementById('claus-ms-desxifrar').style.display = 'none';
      }
      document.getElementById('spinner').style.display = 'none';
    };

    // ========== Accessibilitat: navegaci√≥ amb teclat ==========
    document.querySelectorAll('.back').forEach(el=>{
      el.addEventListener('keypress', function(ev){
        if (ev.key==='Enter' || ev.key===' ') { mostrarPantalla('inici'); }
      });
    });

    mostrarPantalla('inici');
  </script>
</body>

</html>
